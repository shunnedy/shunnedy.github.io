<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ブロックでうごかそう</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background-color: #fffaf0;
    font-family: "Rounded Mplus 1c", sans-serif;
  }

  #connectSection {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    flex-direction: column;
  }

  #connectButton {
    font-size: 2rem;
    padding: 1rem 2rem;
    background-color: #00bcd4;
    color: white;
    border: none;
    border-radius: 1rem;
  }

  #mainUI {
    display: none;
    width: 100vw;
    height: 100vh;
    position: relative;
  }

  #programArea {
    position: absolute;
    left: 0;
    top: 0;
    width: 50%;
    height: 100%;
    background-color: #ffffff;
    border-right: 3px solid #ccc;
  }

  #spriteArea {
    position: absolute;
    right: 0;
    top: 0;
    width: 50%;
    height: 60%;
    background-color: #e0f7fa;
    border-bottom: 3px solid #ccc;
  }

  #characterArea {
    position: absolute;
    right: 0;
    bottom: 0;
    width: 50%;
    height: 40%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  #character {
    width: 100px;
    height: 100px;
    user-select: none;
    touch-action: none;
    cursor: grab;
  }

  #paintButton {
    margin-top: 10px;
    font-size: 1.2rem;
    background-color: #ffb300;
    color: white;
    border: none;
    border-radius: 1rem;
    padding: 0.5rem 1rem;
  }

  /* おえかきモード */
  #paintArea {
    display: none;
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
    background-color: white;
    border: 3px solid #00bcd4;
    z-index: 10;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #paintCanvas {
    background-color: #f5f5f5;
    border: 2px solid #ccc;
    touch-action: none;
  }

  #saveDrawing {
    margin-top: 10px;
    background-color: #00bcd4;
    color: white;
    font-size: 1.2rem;
    border: none;
    border-radius: 1rem;
    padding: 0.5rem 1rem;
  }

  #closePaint {
    margin-top: 10px;
    background-color: #aaa;
    color: white;
    font-size: 1.2rem;
    border: none;
    border-radius: 1rem;
    padding: 0.5rem 1rem;
  }
</style>
</head>
<body>
  <div id="connectSection">
    <h1>ESP32とつなげよう！</h1>
    <button id="connectButton">せつぞく</button>
  </div>

  <div id="mainUI">
    <div id="programArea"></div>
    <div id="spriteArea"></div>
    <div id="characterArea">
      <img id="character" src="character.png" draggable="false">
      <button id="paintButton">おえかきモード</button>
    </div>

    <div id="paintArea">
      <canvas id="paintCanvas" width="300" height="300"></canvas>
      <button id="saveDrawing">このえをつかう</button>
      <button id="closePaint">とじる</button>
    </div>
  </div>

<script>
let device, characteristic;

// --- ESP32接続処理（安定版） ---
async function connectToESP32() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32_BLE" }],
      optionalServices: [0xFFE0]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(0xFFE0);
    characteristic = await service.getCharacteristic(0xFFE1);
    document.getElementById("connectSection").style.display = "none";
    document.getElementById("mainUI").style.display = "block";
  } catch (error) {
    alert("せつぞくにしっぱいしました");
    console.error(error);
  }
}
document.getElementById("connectButton").addEventListener("click", connectToESP32);

// --- キャラクター配置 ---
const templateChar = document.getElementById("character");
const spriteArea = document.getElementById("spriteArea");
const programArea = document.getElementById("programArea");
const characterArea = document.getElementById("characterArea");

let dragged = null;
let isDragging = false;

function startDrag(e) {
  e.preventDefault();
  dragged = templateChar.cloneNode(true);
  dragged.removeAttribute("id");
  dragged.style.position = "absolute";
  dragged.style.left = e.pageX - 50 + "px";
  dragged.style.top = e.pageY - 50 + "px";
  dragged.style.pointerEvents = "none";
  dragged.style.opacity = "0.9";
  document.body.appendChild(dragged);
  isDragging = true;
}

function moveDrag(e) {
  if (!isDragging || !dragged) return;
  dragged.style.left = e.pageX - 50 + "px";
  dragged.style.top = e.pageY - 50 + "px";
}

function endDrag(e) {
  if (!isDragging || !dragged) return;

  const x = e.clientX;
  const y = e.clientY;

  const spriteRect = spriteArea.getBoundingClientRect();
  const programRect = programArea.getBoundingClientRect();
  const charRect = characterArea.getBoundingClientRect();

  if (
    (x > spriteRect.left && x < spriteRect.right &&
     y > spriteRect.top && y < spriteRect.bottom) ||
    (x > programRect.left && x < programRect.right &&
     y > programRect.top && y < programRect.bottom)
  ) {
    dragged.style.pointerEvents = "auto";
    dragged.style.opacity = "1.0";
  } else {
    dragged.remove();
  }

  dragged = null;
  isDragging = false;
}

templateChar.addEventListener("pointerdown", startDrag);
document.addEventListener("pointermove", moveDrag);
document.addEventListener("pointerup", endDrag);

// --- おえかきモード ---
const paintButton = document.getElementById("paintButton");
const paintArea = document.getElementById("paintArea");
const paintCanvas = document.getElementById("paintCanvas");
const ctx = paintCanvas.getContext("2d");
let drawing = false;

paintButton.addEventListener("click", () => {
  paintArea.style.display = "flex";
  ctx.clearRect(0, 0, paintCanvas.width, paintCanvas.height);
});

paintCanvas.addEventListener("pointerdown", (e) => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
paintCanvas.addEventListener("pointermove", (e) => {
  if (drawing) {
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.stroke();
  }
});
paintCanvas.addEventListener("pointerup", () => drawing = false);
paintCanvas.addEventListener("pointerleave", () => drawing = false);

// 絵をキャラに反映
document.getElementById("saveDrawing").addEventListener("click", () => {
  const imgData = paintCanvas.toDataURL("image/png");
  templateChar.src = imgData;
  paintArea.style.display = "none";
});

// 閉じる
document.getElementById("closePaint").addEventListener("click", () => {
  paintArea.style.display = "none";
});
</script>
</body>
</html>
