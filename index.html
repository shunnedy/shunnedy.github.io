<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32ãƒ‰ãƒƒãƒˆãƒãƒˆãƒªã‚¯ã‚¹ã§ã‚ãã¼ã†ï¼</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f9fafb; }
    #blocklyDiv { height: 480px; width: 100%; margin-top: 10px; }
    button { font-size: 20px; padding: 10px 20px; margin: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ’¡ ãƒ‰ãƒƒãƒˆãƒãƒˆãƒªã‚¯ã‚¹ã§ã‚ãã¼ã†ï¼</h1>
  <div id="blocklyDiv"></div>
  <xml id="toolbox" style="display:none">
    <block type="show_text"></block>
    <block type="wave"></block>
    <block type="blink"></block>
  </xml>
  <button id="connectBtn">ğŸ”— ESP32ã¨ã¤ãªã</button>
  <button id="runBtn">â–¶ ã†ã”ã‹ã™</button>

  <script>
    // ==== ãƒ–ãƒ­ãƒƒã‚¯å®šç¾© ====
    Blockly.defineBlocksWithJsonArray([
      {
        "type": "show_text",
        "message0": "æ–‡å­—ã‚’è¡¨ç¤º %1",
        "args0": [{ "type": "field_input", "name": "TEXT", "text": "ã“ã‚“ã«ã¡ã¯ï¼" }],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 160
      },
      {
        "type": "wave",
        "message0": "ãªã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³",
        "previousStatement": null,
        "nextStatement": null,
        "colour": 210
      },
      {
        "type": "blink",
        "message0": "ãƒ”ã‚«ãƒ”ã‚«ç‚¹æ»…",
        "previousStatement": null,
        "nextStatement": null,
        "colour": 60
      }
    ]);

    // ==== JavaScriptå¤‰æ› ====
    Blockly.JavaScript['show_text'] = block => {
      const text = block.getFieldValue('TEXT');
      return `sendBLE('TEXT:${text}');\n`;
    };
    Blockly.JavaScript['wave'] = () => `sendBLE('WAVE');\n`;
    Blockly.JavaScript['blink'] = () => `sendBLE('BLINK');\n`;

    // ==== BlocklyåˆæœŸåŒ– ====
    const workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

    // ==== Web Bluetooth ====
    let bleCharacteristic = null;
    const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const CHARACTERISTIC_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';

    async function connectBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
        alert('âœ… ESP32ã¨æ¥ç¶šã—ã¾ã—ãŸï¼');
      } catch (e) {
        alert('âŒ æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
      }
    }

    async function sendBLE(msg) {
      if (!bleCharacteristic) {
        alert('å…ˆã«ã€ŒESP32ã¨ã¤ãªãã€ã‚’æŠ¼ã—ã¦ã­ï¼');
        return;
      }
      const encoder = new TextEncoder();
      await bleCharacteristic.writeValue(encoder.encode(msg));
    }

    // ==== ã‚¤ãƒ™ãƒ³ãƒˆ ====
    document.getElementById('connectBtn').onclick = connectBLE;
    document.getElementById('runBtn').onclick = () => {
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      try {
        eval(code);
      } catch (e) {
        console.error(e);
        alert('ãƒ–ãƒ­ãƒƒã‚¯ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚ˆï¼');
      }
    };
  </script>
</body>
</html>
