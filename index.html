<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32ドットマトリクスであそぼう！</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f9fafb; }
    #blocklyDiv { height: 480px; width: 100%; margin-top: 10px; }
    button { font-size: 20px; padding: 10px 20px; margin: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>💡 ドットマトリクスであそぼう！</h1>
  <div id="blocklyDiv"></div>
  <xml id="toolbox" style="display:none">
    <block type="show_text"></block>
    <block type="wave"></block>
    <block type="blink"></block>
  </xml>
  <button id="connectBtn">🔗 ESP32とつなぐ</button>
  <button id="runBtn">▶ うごかす</button>

  <script>
    // ==== ブロック定義 ====
    Blockly.defineBlocksWithJsonArray([
      {
        "type": "show_text",
        "message0": "文字を表示 %1",
        "args0": [{ "type": "field_input", "name": "TEXT", "text": "こんにちは！" }],
        "previousStatement": null,
        "nextStatement": null,
        "colour": 160
      },
      {
        "type": "wave",
        "message0": "なみアニメーション",
        "previousStatement": null,
        "nextStatement": null,
        "colour": 210
      },
      {
        "type": "blink",
        "message0": "ピカピカ点滅",
        "previousStatement": null,
        "nextStatement": null,
        "colour": 60
      }
    ]);

    // ==== JavaScript変換 ====
    Blockly.JavaScript['show_text'] = block => {
      const text = block.getFieldValue('TEXT');
      return `sendBLE('TEXT:${text}');\n`;
    };
    Blockly.JavaScript['wave'] = () => `sendBLE('WAVE');\n`;
    Blockly.JavaScript['blink'] = () => `sendBLE('BLINK');\n`;

    // ==== Blockly初期化 ====
    const workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

    // ==== Web Bluetooth ====
    let bleCharacteristic = null;
    const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const CHARACTERISTIC_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';

    async function connectBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
        alert('✅ ESP32と接続しました！');
      } catch (e) {
        alert('❌ 接続に失敗しました: ' + e);
      }
    }

    async function sendBLE(msg) {
      if (!bleCharacteristic) {
        alert('先に「ESP32とつなぐ」を押してね！');
        return;
      }
      const encoder = new TextEncoder();
      await bleCharacteristic.writeValue(encoder.encode(msg));
    }

    // ==== イベント ====
    document.getElementById('connectBtn').onclick = connectBLE;
    document.getElementById('runBtn').onclick = () => {
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      try {
        eval(code);
      } catch (e) {
        console.error(e);
        alert('ブロックの実行中にエラーが起きたよ！');
      }
    };
  </script>
</body>
</html>
