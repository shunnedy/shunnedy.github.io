<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ブロックでうごかそう</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background-color: #fffaf0;
    font-family: "Rounded Mplus 1c", sans-serif;
  }

  #connectSection {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    flex-direction: column;
  }

  #connectButton {
    font-size: 2rem;
    padding: 1rem 2rem;
    background-color: #00bcd4;
    color: white;
    border: none;
    border-radius: 1rem;
  }

  #mainUI {
    display: none;
    width: 100vw;
    height: 100vh;
    position: relative;
  }

  #programArea {
    position: absolute;
    left: 0;
    top: 0;
    width: 50%;
    height: 100%;
    background-color: #ffffff;
    border-right: 3px solid #ccc;
  }

  #spriteArea {
    position: absolute;
    right: 0;
    top: 0;
    width: 50%;
    height: 60%;
    background-color: #e0f7fa;
    border-bottom: 3px solid #ccc;
  }

  #characterArea {
    position: absolute;
    right: 0;
    bottom: 0;
    width: 50%;
    height: 40%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #character {
    width: 100px;
    height: 100px;
    user-select: none;
    touch-action: none;
    cursor: grab;
  }
</style>
</head>
<body>
  <div id="connectSection">
    <h1>ESP32とつなげよう！</h1>
    <button id="connectButton">せつぞく</button>
  </div>

  <div id="mainUI">
    <div id="programArea"></div>
    <div id="spriteArea"></div>
    <div id="characterArea">
      <!-- テンプレートキャラ（消えない） -->
      <img id="character" src="character.png" draggable="false">
    </div>
  </div>

<script>
let device, characteristic;

// --- BLE接続 ---
async function connectToESP32() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32_BLE" }],
      optionalServices: [0xFFE0]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(0xFFE0);
    characteristic = await service.getCharacteristic(0xFFE1);

    document.getElementById("connectSection").style.display = "none";
    document.getElementById("mainUI").style.display = "block";
  } catch (error) {
    alert("せつぞくにしっぱいしました");
    console.error(error);
  }
}

document.getElementById("connectButton").addEventListener("click", connectToESP32);

// --- キャラクター配置機能 ---
const templateChar = document.getElementById("character");
const spriteArea = document.getElementById("spriteArea");
const programArea = document.getElementById("programArea");
const characterArea = document.getElementById("characterArea");

let dragged = null;
let isDragging = false;

function startDrag(e) {
  e.preventDefault();
  // テンプレートをコピーして持ち上げる
  dragged = templateChar.cloneNode(true);
  dragged.removeAttribute("id");
  dragged.style.position = "absolute";
  dragged.style.left = e.pageX - 50 + "px";
  dragged.style.top = e.pageY - 50 + "px";
  dragged.style.pointerEvents = "none";
  dragged.style.opacity = "0.9";
  document.body.appendChild(dragged);
  isDragging = true;
}

function moveDrag(e) {
  if (!isDragging || !dragged) return;
  dragged.style.left = e.pageX - 50 + "px";
  dragged.style.top = e.pageY - 50 + "px";
}

function endDrag(e) {
  if (!isDragging || !dragged) return;

  const x = e.clientX;
  const y = e.clientY;

  const spriteRect = spriteArea.getBoundingClientRect();
  const programRect = programArea.getBoundingClientRect();
  const charRect = characterArea.getBoundingClientRect();

  // スプライトまたはプログラムエリア内なら配置
  if (
    (x > spriteRect.left && x < spriteRect.right &&
     y > spriteRect.top && y < spriteRect.bottom) ||
    (x > programRect.left && x < programRect.right &&
     y > programRect.top && y < programRect.bottom)
  ) {
    dragged.style.pointerEvents = "auto";
    dragged.style.opacity = "1.0";
  } else if (
    x > charRect.left && x < charRect.right &&
    y > charRect.top && y < charRect.bottom
  ) {
    // 元のエリアに戻したら削除
    dragged.remove();
  } else {
    // その他の場所も削除（安全策）
    dragged.remove();
  }

  dragged = null;
  isDragging = false;
}

// 右下のテンプレキャラは「触るとコピーして持ち上げる」
templateChar.addEventListener("pointerdown", startDrag);
document.addEventListener("pointermove", moveDrag);
document.addEventListener("pointerup", endDrag);
</script>
</body>
</html>
