<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã²ã‹ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  body { font-family: sans-serif; text-align: center; background: #f8fafc; }
  #blocklyDiv { height: 400px; width: 90%; margin: auto; border-radius: 12px; overflow: hidden; }
  button { margin: 10px; padding: 10px 20px; font-size: 18px; border-radius: 10px; }
</style>
</head>
<body>
<h1>ğŸŒˆ ã²ã‹ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</h1>
<button id="connect">ğŸ”— ESP32ã¨ã¤ãªã</button>
<button id="run">â–¶ï¸ ã†ã”ã‹ã™</button>
<div id="blocklyDiv"></div>

<script>
const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
const CHARACTERISTIC_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
let characteristic = null;

// BlocklyåˆæœŸåŒ–
const workspace = Blockly.inject('blocklyDiv', {
  toolbox: {
    kind: 'flyoutToolbox',
    contents: [
      { kind: 'block', type: 'show_text' },
      { kind: 'block', type: 'show_shape' },
      { kind: 'block', type: 'play_anim' }
    ]
  }
});

// ãƒ–ãƒ­ãƒƒã‚¯å®šç¾©
Blockly.defineBlocksWithJsonArray([
  {
    "type": "show_text",
    "message0": "æ–‡å­— %1 ã‚’ã²ã‚‡ã†ã˜",
    "args0": [{ "type": "field_input", "name": "TEXT", "text": "HELLO" }],
    "colour": 160,
    "tooltip": "æ–‡å­—ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¡¨ç¤ºã—ã¾ã™",
    "output": null
  },
  {
    "type": "show_shape",
    "message0": "%1 ã®ã‹ãŸã¡ã‚’ã¤ã‘ã‚‹",
    "args0": [{
      "type": "field_dropdown",
      "name": "SHAPE",
      "options": [
        ["ãƒãƒ¼ãƒˆ", "HEART"],
        ["ã¾ã‚‹", "CIRCLE"],
        ["ã‚¹ãƒã‚¤ãƒ«", "SMILE"]
      ]
    }],
    "colour": 20,
    "output": null
  },
  {
    "type": "play_anim",
    "message0": "%1 ã‚¢ãƒ‹ãƒ¡ã‚’ã¿ã›ã‚‹",
    "args0": [{
      "type": "field_dropdown",
      "name": "ANIM",
      "options": [
        ["ãƒ”ã‚«ãƒ”ã‚«", "BLINK"],
        ["ã‚¦ã‚§ãƒ¼ãƒ–", "WAVE"],
        ["ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼", "RAINBOW"]
      ]
    }],
    "colour": 260,
    "output": null
  }
]);

// JSç”Ÿæˆ
Blockly.JavaScript['show_text'] = (block) => {
  const text = block.getFieldValue('TEXT');
  return `"TEXT:${text}"`;
};
Blockly.JavaScript['show_shape'] = (block) => {
  const shape = block.getFieldValue('SHAPE');
  return `"SHAPE:${shape}"`;
};
Blockly.JavaScript['play_anim'] = (block) => {
  const anim = block.getFieldValue('ANIM');
  return `"ANIM:${anim}"`;
};

// BLEæ¥ç¶š
document.getElementById('connect').onclick = async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32_LED_Display" }],
      optionalServices: [SERVICE_UUID]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
    alert("âœ… ESP32ã¨ã¤ãªãŒã£ãŸã‚ˆï¼");
  } catch (e) {
    alert("âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + e);
  }
};

// å®Ÿè¡Œ
document.getElementById('run').onclick = async () => {
  if (!characteristic) {
    alert("ESP32ã¨ã¤ãªã„ã§ã­ï¼");
    return;
  }
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  const commands = code.match(/"[^"]*"/g); // æ­£è¦è¡¨ç¾ã§æ–‡å­—åˆ—ã‚’æŠ½å‡º
  if (!commands) {
    alert("ãƒ–ãƒ­ãƒƒã‚¯ã‚’é…ç½®ã—ã¦ã­ï¼");
    return;
  }
  const encoder = new TextEncoder();
  for (const cmd of commands) {
    const payload = JSON.parse(cmd); // JSON.parseã§æ–‡å­—åˆ—ã«å¤‰æ›
    await characteristic.writeValue(encoder.encode(payload));
    await new Promise(r => setTimeout(r, 800));
  }
  alert("âœ¨ ã†ã”ã‹ã—ãŸã‚ˆï¼");
};
</script>
</body>
</html>
